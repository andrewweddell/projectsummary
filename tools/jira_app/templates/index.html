{% extends "base.html" %}

{% block content %}
<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-tasks fa-2x me-3"></i>
                    <div>
                        <h4 class="mb-0">{{ stats.total or 0 }}</h4>
                        <small>Total Tickets</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle fa-2x me-3"></i>
                    <div>
                        <h4 class="mb-0">{{ stats.done or 0 }}</h4>
                        <small>Done</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-clock fa-2x me-3"></i>
                    <div>
                        <h4 class="mb-0">{{ stats.in_progress or 0 }}</h4>
                        <small>In Progress</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-list fa-2x me-3"></i>
                    <div>
                        <h4 class="mb-0">{{ stats.todo or 0 }}</h4>
                        <small>To Do</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-secondary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-flag fa-2x me-3"></i>
                    <div>
                        <h4 class="mb-0">{{ stats.epics or 0 }}</h4>
                        <small>Epics</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-dark text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <i class="fas fa-book fa-2x me-3"></i>
                    <div>
                        <h4 class="mb-0">{{ stats.stories or 0 }}</h4>
                        <small>Stories</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mb-4">
    <div class="col-12">
        <button onclick="syncTickets()" class="btn btn-primary me-2">
            <i class="fas fa-sync"></i> Sync from Jira
        </button>
        <button onclick="createAllTickets()" class="btn btn-success me-2">
            <i class="fas fa-plus"></i> Create All Project Tickets
        </button>
        <div class="btn-group me-2" role="group">
            <button type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-file-export"></i> Project Reports
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('export_markdown') }}">
                    <i class="fas fa-download"></i> Generate New Report
                </a></li>
                <li><a class="dropdown-item" href="{{ url_for('download_latest_report') }}">
                    <i class="fas fa-file-alt"></i> Download Latest Report
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item disabled">
                    <i class="fas fa-info-circle"></i> Auto-generated after sync
                </a></li>
            </ul>
        </div>
        <div class="btn-group me-2" role="group">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-filter"></i> Filter
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="filterTickets('all')">All Tickets</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterTickets('Epic')">Epics</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterTickets('Story')">Stories</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterTickets('Task')">Tasks</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="filterTickets('To Do')">To Do</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterTickets('In Progress')">In Progress</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterTickets('Done')">Done</a></li>
            </ul>
        </div>
    </div>
</div>

<!-- Tickets List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i> Project Tickets
                </h5>
                <small class="text-muted">
                    {% if tickets %}
                        Last sync: {{ tickets[0].updated[:19] if tickets[0].get('updated') else 'Never' }}
                    {% else %}
                        No tickets found. Click "Sync from Jira" or "Create All Project Tickets"
                    {% endif %}
                </small>
            </div>
            <div class="card-body">
                {% if tickets %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Type</th>
                                    <th>Summary</th>
                                    <th>Status</th>
                                    <th>Assignee</th>
                                    <th>Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ticketsTableBody">
                                {% for ticket in tickets %}
                                <tr data-type="{{ ticket.issue_type }}" data-status="{{ ticket.status }}">
                                    <td>
                                        <strong>{{ ticket.key }}</strong>
                                        {% if ticket.parent %}
                                            <br><small class="text-muted">â†³ {{ ticket.parent }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if ticket.issue_type == 'Epic' %}
                                            <span class="badge bg-purple text-white">
                                                <i class="fas fa-flag"></i> Epic
                                            </span>
                                        {% elif ticket.issue_type == 'Story' %}
                                            <span class="badge bg-primary">
                                                <i class="fas fa-book"></i> Story
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-check-square"></i> {{ ticket.issue_type }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('view_ticket', ticket_key=ticket.key) }}" class="text-decoration-none">
                                            {{ ticket.summary }}
                                        </a>
                                    </td>
                                    <td>
                                        {% set status_class = 'secondary' %}
                                        {% if 'done' in ticket.status.lower() or 'closed' in ticket.status.lower() %}
                                            {% set status_class = 'success' %}
                                        {% elif 'progress' in ticket.status.lower() %}
                                            {% set status_class = 'warning' %}
                                        {% elif 'to do' in ticket.status.lower() or 'open' in ticket.status.lower() %}
                                            {% set status_class = 'info' %}
                                        {% endif %}
                                        <span class="badge bg-{{ status_class }} status-badge">{{ ticket.status }}</span>
                                    </td>
                                    <td>
                                        {% if ticket.assignee %}
                                            <small>{{ ticket.assignee }}</small>
                                        {% else %}
                                            <small class="text-muted">Unassigned</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ ticket.updated[:19] if ticket.updated else 'N/A' }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('view_ticket', ticket_key=ticket.key) }}" 
                                               class="btn btn-outline-primary" title="View">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('edit_ticket', ticket_key=ticket.key) }}" 
                                               class="btn btn-outline-secondary" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5>No tickets found</h5>
                        <p class="text-muted">Start by syncing tickets from Jira or creating new project tickets.</p>
                        <button onclick="syncTickets()" class="btn btn-primary me-2">
                            <i class="fas fa-sync"></i> Sync from Jira
                        </button>
                        <button onclick="createAllTickets()" class="btn btn-success">
                            <i class="fas fa-plus"></i> Create All Project Tickets
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function syncTickets() {
    if (confirm('This will sync all tickets from Jira. Continue?')) {
        // Use the new progress tracking system
        startProgressOperation(
            '{{ url_for("sync_tickets") }}', 
            'Syncing Tickets from Jira',
            syncTickets // Retry callback
        ).catch(error => {
            console.error('Failed to start sync operation:', error);
        });
    }
}

function createAllTickets() {
    if (confirm('This will create all project tickets in Jira. This may take a few minutes. Continue?')) {
        // Use the new progress tracking system
        startProgressOperation(
            '{{ url_for("create_all_tickets") }}', 
            'Creating All Project Tickets',
            createAllTickets // Retry callback
        ).catch(error => {
            console.error('Failed to start ticket creation:', error);
        });
    }
}

function filterTickets(filter) {
    const rows = document.querySelectorAll('#ticketsTableBody tr');
    
    rows.forEach(row => {
        if (filter === 'all') {
            row.style.display = '';
        } else {
            const type = row.getAttribute('data-type');
            const status = row.getAttribute('data-status');
            
            if (type === filter || status === filter) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });
}

// Add purple background for Epic badges
const style = document.createElement('style');
style.textContent = '.bg-purple { background-color: #6f42c1 !important; }';
document.head.appendChild(style);
</script>
{% endblock %}